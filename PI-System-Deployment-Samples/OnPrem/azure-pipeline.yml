trigger:
  batch: true
  branches:
    include:
      - master
  paths:
    include:
      - '/PI-System-Deployment-Samples/OnPrem'

pr:
  branches:
    include:
      - master
  paths:
    include:
      - '/PI-System-Deployment-Samples/OnPrem'

schedules:
  - cron: '0 0 * * 0'
    displayName: Weekly build
    branches:
      include:
        - master
    always: true

variables:
  - template: '/miscellaneous/build_templates/variables.yml'
  - name: projPath
    value: '/PI-System-Deployment-Samples/OnPrem'
  - name: win10vm
    value: PRGPSDWIN10
  - name: srv16vm
    value: PRGPSDSRV16

jobs:
  - job: Tests_SRV16
    pool:
      name: 00-OSIManaged-Test
      demands: COMPUTERNAME -equals $(buildAgent)
    steps:
      - task: ms-vscs-rm.scvmmapp.scvmmresourcedeployment-task.SCVMM@1
        inputs:
          ConnectedServiceName: 'product-readiness.SCVMM'
          VMList: $(srv16vm)
          CheckPointName: Initial
          ScopeFilter: CloudFiltering
          CloudFilter: OAK
          CreateBoundaryVM: false
          NoDetailedLogs: false
        displayName: 'SCVMM: Restore VM Checkpoint'

      - task: ms-vscs-rm.scvmmapp.scvmmresourcedeployment-task.SCVMM@1
        inputs:
          ConnectedServiceName: 'product-readiness.SCVMM'
          VMList: $(srv16vm)
          Action: StartVM
          ScopeFilter: CloudFiltering
          CloudFilter: OAK
          CreateBoundaryVM: false
          NoDetailedLogs: false
        displayName: 'SCVMM: Start VM'

      - task: CopyFiles@2
        inputs:
          sourceFolder: $(Build.SourcesDirectory)$(projPath)
          contents: '*.ps1'
          targetFolder: '\\$(srv16vm)\C$\Test'
        displayName: 'Copy PowerShell script'

      - task: PowerShellOnTargetMachines@3
        inputs:
          machines: $(srv16vm)
          communicationProtocol: http
          scriptType: filePath
          scriptPath: 'C:\Test\Install-PIServer.ps1'
          scriptArguments: '-sql .\SQL\SETUP.EXE -piserver .\PIServer.exe -pilicdir C:\Test -afdatabase TestDatabase -pibundle .\PIProcessBook.exe'
          workingDirectory: 'C:\Test'
        displayName: 'Run PowerShell script'

      - task: PowerShellOnTargetMachines@3
        inputs:
          machines: $(srv16vm)
          communicationProtocol: http
          scriptType: filePath
          scriptPath: 'C:\Test\Verify-PIServer.ps1'
        displayName: 'Run tests'

      - task: ms-vscs-rm.scvmmapp.scvmmresourcedeployment-task.SCVMM@1
        inputs:
          ConnectedServiceName: 'product-readiness.SCVMM'
          VMList: $(srv16vm)
          Action: StopVM
          ScopeFilter: CloudFiltering
          CloudFilter: OAK
          CreateBoundaryVM: false
          NoDetailedLogs: false
        displayName: 'SCVMM: Stop VM'
        condition: always()
  # - job: Tests Windows 10
  #   pool:
  #     name: 00-OSIManaged-Test
  #     demands: COMPUTERNAME -equals $(buildAgent)
  #   steps:
  #     - script: ''
  #       workingDirectory: $(Build.SourcesDirectory)$(projPath)
  #       displayName: 'Run tests'
  # - template: '/miscellaneous/build_templates/analysis.yml'
  #   parameters:
  #     language: powershell
